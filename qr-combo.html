<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>QR Code Scanner (Camera or Image)</title>
  <link rel="stylesheet" href="https://unpkg.com/normalize.css@8.0.0/normalize.css">
  <link rel="stylesheet" href="https://unpkg.com/milligram@1.3.0/dist/milligram.min.css">
</head>
<body>
  <main class="wrapper" style="padding-top:2em">
    <section class="container">
      <h1>QR Code Scanner</h1>
      <div>
        <label><input type="radio" name="mode" value="camera" checked> Camera</label>
        <label><input type="radio" name="mode" value="image"> Image Upload</label>
      </div>
      <div id="camera-section">
        <div>
          <a class="button" id="startButton">Start</a>
          <a class="button" id="resetButton">Reset</a>
        </div>
        <div>
          <video id="video" width="300" height="200" style="border: 1px solid gray"></video>
          <div id="sourceSelectPanel" style="display:none">
            <label for="sourceSelect">Change video source:</label>
            <select id="sourceSelect" style="max-width:400px"></select>
          </div>
        </div>
      </div>
      <div id="image-section" style="display:none">
        <input type="file" id="fileInput" accept="image/*">
        <div>
          <img id="img" style="max-width:300px; border:1px solid gray; display:none;">
        </div>
        <a class="button" id="decodeButton">Decode</a>
      </div>
      <label>Result:</label>
      <pre><code id="result"></code></pre>
    </section>
  </main>
  <script src="library\dist\umd\index.min.js"></script>
  <script>
    const cameraSection = document.getElementById('camera-section');
    const imageSection = document.getElementById('image-section');
    const resultElem = document.getElementById('result');
    let codeReader;
    let selectedDeviceId;

    // Mode switch
    document.querySelectorAll('input[name="mode"]').forEach(radio => {
      radio.addEventListener('change', function() {
        if (this.value === 'camera') {
          cameraSection.style.display = '';
          imageSection.style.display = 'none';
          resultElem.textContent = '';
        } else {
          cameraSection.style.display = 'none';
          imageSection.style.display = '';
          resultElem.textContent = '';
        }
        if (codeReader) codeReader.reset();
      });
    });

    document.addEventListener('DOMContentLoaded', function() {
      codeReader = new ZXing.BrowserQRCodeReader();
      const sourceSelect = document.getElementById('sourceSelect');
      const sourceSelectPanel = document.getElementById('sourceSelectPanel');

      // Camera logic
      function populateDeviceList(devices) {
        sourceSelect.innerHTML = '';
        devices.forEach((device, idx) => {
          const option = document.createElement('option');
          option.text = device.label;
          option.value = device.deviceId;
          sourceSelect.appendChild(option);
        });
        sourceSelectPanel.style.display = devices.length > 1 ? 'block' : 'none';
      }

      sourceSelect.addEventListener('change', function() {
        selectedDeviceId = this.value;
      });

      document.getElementById('startButton').addEventListener('click', () => {
        codeReader.getVideoInputDevices().then(devices => {
          if (devices.length === 0) {
            resultElem.textContent = 'No camera found.';
            console.error('No camera found.');
            return;
          }
          selectedDeviceId = devices[0].deviceId;
          console.log('Started decode from camera with id', selectedDeviceId);
          codeReader.decodeFromInputVideoDevice(selectedDeviceId, 'video').then(result => {
            console.log(result);
            resultElem.textContent = result.text;
            codeReader.getVideoInputDevices().then(populateDeviceList);
          }).catch(err => {
            console.error(err);
            resultElem.textContent = err;
            codeReader.getVideoInputDevices().then(populateDeviceList);
          });
        }).catch(err => {
          resultElem.textContent = 'No camera found.';
          console.error('No camera found.', err);
        });
      });

      document.getElementById('resetButton').addEventListener('click', () => {
        codeReader.reset();
        resultElem.textContent = '';
        console.log('Reset.');
      });

      // Image logic
      const fileInput = document.getElementById('fileInput');
      const img = document.getElementById('img');
      fileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
          img.src = URL.createObjectURL(file);
          img.style.display = '';
        } else {
          img.src = '';
          img.style.display = 'none';
        }
        resultElem.textContent = '';
      });

      document.getElementById('decodeButton').addEventListener('click', function() {
        if (!img.src) {
          resultElem.textContent = 'Please select an image.';
          return;
        }
        console.log('Started decode for image from', img.src);
        codeReader.decodeFromImage(img).then(result => {
          console.log(result);
          resultElem.textContent = result.text;
        }).catch(err => {
          console.error(err);
          resultElem.textContent = err;
        });
      });
    });
  </script>
</body>
</html> 